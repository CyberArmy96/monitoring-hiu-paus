<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Hiu Paus - Real Time Dashboard</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #e74c3c;
            animation: pulse 2s infinite;
            display: inline-block;
        }
        
        .status-indicator.connected {
            background: #27ae60;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .info-bar {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #7f8c8d;
            font-size: 0.95em;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 20px;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 50px rgba(0,0,0,0.15);
        }
        
        .card-title {
            font-size: 1.2em;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .metric-display {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 12px;
            padding: 20px;
            color: white;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .metric-display::before {
            content: "";
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }
        
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
            position: relative;
            z-index: 1;
        }
        
        .metric-label {
            font-size: 1em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        
        .metric-unit {
            font-size: 0.5em;
            opacity: 0.8;
            margin-left: 5px;
        }
        
        .chart-container {
            position: relative;
            height: 250px;
            margin-top: 20px;
        }

        #map {
            height: 400px;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .control-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #e8eaf6;
            color: #667eea;
        }
        
        .btn-secondary:hover {
            background: #d4d7e8;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .data-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: center;
            vertical-align: middle;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table th {
            background: #f5f5f5;
            font-weight: 600;
            color: #2c3e50;
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
        }

        /* Tambahkan di dalam tag <style> di bagian atas file HTML */
        .empty-row {
            opacity: 0.3;
            font-style: italic;
        }

        .empty-cell {
            color: #999;
            text-align: center;
        }

        .new-data-row {
            animation: highlightRow 1s ease;
            background-color: #e3f2fd !important;
        }

        @keyframes highlightRow {
            0% {
                background-color: #bbdefb;
                transform: translateX(-10px);
                opacity: 0;
            }
            100% {
                background-color: #e3f2fd;
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #e74c3c;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #27ae60;
        }
        
        .pump-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .pump-status.on {
            background: #d4edda;
            color: #155724;
        }
        
        .pump-status.off {
            background: #f8f9fa;
            color: #6c757d;
        }
        
        .timestamp {
            color: #7f8c8d;
            font-size: 0.85em;
            margin-top: 10px;
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #whatsapp-button {
            position: fixed; 
            bottom: 25px;
            right: 25px;
            z-index: 1000;
    
            background-color: #25D366;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.25);
    
            display: flex;
            justify-content: center;
            align-items: center;
    
            font-size: 36px;
            text-decoration: none;
    
            transition: transform 0.2s ease-in-out;
        }

        #whatsapp-button:hover {
            transform: scale(1.1);
        }

        .footer-credit {
            padding: 40px 20px;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .credit-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .credit-line {
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
        }

        .credit-text {
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            font-weight: 400;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .credit-name {
            font-weight: 600;
            background: linear-gradient(135deg, #fa709a, #fee140);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 16px;
            padding: 0 4px;
        }

        .credit-year {
            opacity: 0.7;
            font-size: 12px;
        }

        .heart {
            animation: heartbeat 1.5s ease-in-out infinite;
            display: inline-block;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .credit-icon {
            font-size: 20px;
            animation: swim 3s ease-in-out infinite;
        }

        @keyframes swim {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(5px); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                🐟 Alifia Paus
                <span class="status-indicator" id="connectionStatus"></span>
            </h1>
            <div class="info-bar">
                <div class="info-item">
                    <span>📍 Device ID:</span>
                    <strong id="deviceId">Adinda_Putri</strong>
                </div>
                <div class="info-item">
                    <span>🌐 Status:</span>
                    <strong id="connectionText">Connecting...</strong>
                </div>
                <div class="info-item">
                    <span>📊 Data Accuracy:</span>
                    <strong id="dataQuality">--</strong>
                </div>
                <div class="info-item">
                    <span>⏱️ Last Update:</span>
                    <strong id="lastUpdate">--</strong>
                </div>
                <div class="info-item">
                    <span>💉 Pump:</span>
                    <span class="pump-status off" id="pumpStatus">OFF</span>
                </div>
            </div>
        </div>
        
        <!-- Alerts Container -->
        <div id="alertsContainer"></div>
        
        <!-- Control Panel -->
        <div class="control-panel">
            <div class="card-title">📡 Control Panel</div>
            <div class="control-buttons">
                <button class="btn btn-primary" onclick="connectMQTT()">
                    🔄 Reconnect
                </button>
                <button class="btn btn-secondary" onclick="exportData()">
                    📥 Export Data
                </button>
                <button class="btn btn-secondary" onclick="clearCharts()">
                    🗑️ Clear Charts
                </button>
                <button class="btn btn-danger" onclick="emergencyRelease()">
                    ⚠️ Emergency Release
                </button>
            </div>
        </div>
        
        <!-- Main Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Speed Card -->
            <div class="card">
                <div class="card-title">
                    🏊 Kecepatan Berenang
                </div>
                <div class="metric-display">
                    <div class="metric-label">Kecepatan</div>
                    <div class="metric-value">
                        <span id="speedValue">0.0</span>
                        <span class="metric-unit">cm/s</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="speedChart"></canvas>
                </div>
            </div>
            
            <!-- Temperature Card -->
            <div class="card">
                <div class="card-title">
                    🌡️ Suhu Air
                </div>
                <div class="metric-display" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                    <div class="metric-label">Suhu</div>
                    <div class="metric-value">
                        <span id="tempValue">0.0</span>
                        <span class="metric-unit">°C</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="tempChart"></canvas>
                </div>
            </div>
            
            <!-- Dissolved Oxygen Card -->
            <div class="card">
                <div class="card-title">
                    💧 Oksigen Terlarut
                </div>
                <div class="metric-display" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
                    <div class="metric-label">Kadar Oksigen</div>
                    <div class="metric-value">
                        <span id="doValue">0.0</span>
                        <span class="metric-unit">mg/L</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="doChart"></canvas>
                </div>
            </div>
            
            <!-- Pressure Card -->
            <div class="card">
                <div class="card-title">
                    🎯 Kompartemen Penghisap
                </div>
                <div class="metric-display" style="background: linear-gradient(135deg, #fa709a, #fee140);">
                    <div class="metric-label">Daya Hisap</div>
                    <div class="metric-value">
                        <span id="pressureValue">0.0</span>
                        <span class="metric-unit">kPa</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="pressureChart"></canvas>
                </div>
            </div>
            
            <!-- Depth Card -->
            <div class="card">
                <div class="card-title">
                    🌊 Posisi
                </div>
                <div class="metric-display" style="background: linear-gradient(135deg, #30cfd0, #330867);">
                    <div class="metric-label">Kedalaman</div>
                    <div class="metric-value">
                        <span id="depthValue">0.0</span>
                        <span class="metric-unit">m</span>
                    </div>
                </div>
                <table class="data-table">
                    <tr>
                        <td><strong>Lintang:</strong></td>
                        <td id="latitude">--</td>
                    </tr>
                    <tr>
                        <td><strong>Bujur:</strong></td>
                        <td id="longitude">--</td>
                    </tr>
                    <tr>
                        <td><strong>Satelit Terhubung:</strong></td>
                        <td id="satellites">--</td>
                    </tr>
                </table>
            </div>
        </div>
        
        <!-- Map Section -->
        <div class="card">
            <div class="card-title">
                🗺️ GPS Tracking (Kalo GPS NEO Berfungsi)
            </div>
            <div id="map"></div>
        </div>
        
        <!-- Historical Data Table -->
        <div class="card">
            <div class="card-title">
                📊 Data Terkini
            </div>
            <table class="data-table" id="dataTable">
                <thead>
                    <tr>
                        <th>Waktu</th>
                        <th>Kecepatan (cm/s)</th>
                        <th>Suhu Air (°C)</th>
                        <th>Kadar Oksigen (mg/L)</th>
                        <th>Daya Hisap (kPa)</th>
                        <th>Kedalaman (m)</th>
                        <th>Akurasi Data</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        // Configuration
        // GANTI SEMUA NILAI INI SESUAI MQTT BROKER ANDA
        const MQTT_BROKER = 'http://b8ae5c3ad3484c4fa485c54ae6eb8ca2.s1.eu.hivemq.cloud'; // Ganti dengan alamat broker Anda
        const MQTT_PORT = 8884; // WebSocket port (8000 untuk public, 8884 untuk HiveMQ Cloud)
        const MQTT_USERNAME = 'hiupaus'; // Isi dengan username MQTT (kosongkan jika tidak ada)
        const MQTT_PASSWORD = 'HiuPaus123'; // Isi dengan password MQTT (kosongkan jika tidak ada)
        const MQTT_USE_SSL = true; // Ganti true jika pakai HiveMQ Cloud
        const MQTT_TOPIC = 'fish/monitor/data';
        const MAX_DATA_POINTS = 50;
        
        // Global variables
        let mqttClient = null;
        let connected = false;
        let map = null;
        let marker = null;
        let pathLine = null;
        let pathCoordinates = [];
        
        // Data storage
        let historicalData = {
            timestamps: [],
            speed: [],
            temperature: [],
            dissolvedOxygen: [],
            pressure: [],
            depth: []
        };
        
        // Chart instances
        let speedChart, tempChart, doChart, pressureChart;
        
        // Initialize everything on page load
        window.onload = function() {
            initializeCharts();
            initializeMap();
            initializeEmptyTable();
            connectMQTT();
            updateTimestamp();
        };
        
        function initializeEmptyTable() {
            const tableBody = document.getElementById('dataTableBody');
            tableBody.innerHTML = '';
    
            for (let i = 0; i < 10; i++) {
                const emptyRow = document.createElement('tr');
                emptyRow.classList.add('empty-row');
                emptyRow.innerHTML = `
                    <td class="empty-cell">--:--:--</td>
                    <td class="empty-cell">--</td>
                    <td class="empty-cell">--</td>
                    <td class="empty-cell">--</td>
                    <td class="empty-cell">--</td>
                    <td class="empty-cell">--</td>
                    <td class="empty-cell">--</td>
                `;
                tableBody.appendChild(emptyRow);
            }
        
        }
        // Initialize all charts
        function initializeCharts() {
            // Common chart options
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 750
                },
                scales: {
                    x: {
                        display: true,
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        display: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            };
            
            // Speed Chart
            speedChart = new Chart(document.getElementById('speedChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: {
                            ...commonOptions.scales.y,
                            title: {
                                display: true,
                                text: '(cm/s)'
                            }
                        }
                    }
                }
            });
            
            // Temperature Chart
            tempChart = new Chart(document.getElementById('tempChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        borderColor: '#f5576c',
                        backgroundColor: 'rgba(245, 87, 108, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: {
                            ...commonOptions.scales.y,
                            title: {
                                display: true,
                                text: '(°C)'
                            }
                        }
                    }
                }
            });
            
            // DO Chart
            doChart = new Chart(document.getElementById('doChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        borderColor: '#00f2fe',
                        backgroundColor: 'rgba(0, 242, 254, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: {
                            ...commonOptions.scales.y,
                            title: {
                                display: true,
                                text: '(mg/L)'
                            }
                        }
                    }
                }
            });
            
            // Pressure Chart
            pressureChart = new Chart(document.getElementById('pressureChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        borderColor: '#fa709a',
                        backgroundColor: 'rgba(250, 112, 154, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: {
                            ...commonOptions.scales.y,
                            title: {
                                display: true,
                                text: '(kPa)'
                            }
                        }
                    }
                }
            });
        }
        // Initialize Leaflet Map
        function initializeMap() {
            // Default center (Indonesia)
            map = L.map('map').setView([-2.5489, 118.0149], 5);
            
            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            // Initialize path line
            pathLine = L.polyline([], {
                color: '#667eea',
                weight: 3,
                opacity: 0.7,
                smoothFactor: 1
            }).addTo(map);
        }
        
        function connectMQTT() {
            if (typeof Paho === 'undefined' || !Paho.MQTT) {
                console.error('Paho MQTT library not loaded. Retrying...');
                setTimeout(connectMQTT, 2000);
                return;
            }
    
            console.log('Connecting to MQTT broker...');
    
            try {
                const clientId = 'web_' + Math.random().toString(16).substr(2, 8);
                mqttClient = new Paho.MQTT.Client(MQTT_BROKER, MQTT_PORT, clientId);
        
                mqttClient.onConnectionLost = onConnectionLost;
                mqttClient.onMessageArrived = onMessageArrived;
        
                const options = {
                    timeout: 3,
                    onSuccess: onConnect,
                    onFailure: onConnectFailure,
                    useSSL: MQTT_USE_SSL,

                    userName: MQTT_USERNAME.length > 0 ? MQTT_USERNAME : undefined,
                    password: MQTT_PASSWORD.length > 0 ? MQTT_PASSWORD : undefined
                };
        
                mqttClient.connect(options);
            } catch (error) {
                console.error('Error creating MQTT client:', error);
                showAlert('Failed to initialize MQTT connection', 'danger');
            }
        }
        
        function onConnect() {
            console.log('Connected to MQTT broker');
            connected = true;
            updateConnectionStatus(true);
            
            // Subscribe to topic
            mqttClient.subscribe(MQTT_TOPIC);
            
            showAlert('Connected!', 'success');
        }
        
        function onConnectFailure(error) {
            console.error('Failed to connect:', error);
            connected = false;
            updateConnectionStatus(false);
            
            showAlert('Failed to connect. Retrying...', 'danger');
            
            // Retry connection after 5 seconds
            setTimeout(connectMQTT, 5000);
        }
        
        function onConnectionLost(responseObject) {
            console.log('Connection lost:', responseObject.errorMessage);
            connected = false;
            updateConnectionStatus(false);
            
            showAlert('Connection lost. Reconnecting...', 'warning');
            
            // Attempt to reconnect
            setTimeout(connectMQTT, 3000);
        }
        
        function onMessageArrived(message) {
            try {
                const data = JSON.parse(message.payloadString);
                console.log('Data received:', data);
                
                // Update UI with new data
                updateDashboard(data);
                
                // Store historical data
                storeData(data);
                
                // Update charts
                updateCharts();
                
                // Update map
                updateMap(data);
                
                // Check for alerts
                checkAlerts(data);
                
                // Update table
                updateDataTable(data);
                
            } catch (error) {
                console.error('Error processing message:', error);
            }
        }
        
        // Update dashboard with new data
        function updateDashboard(data) {
            // Update main metrics
            document.getElementById('speedValue').textContent = data.speed_cms?.toFixed(1) || '0.0';
            document.getElementById('tempValue').textContent = data.temperature?.toFixed(1) || '0.0';
            document.getElementById('doValue').textContent = data.dissolved_oxygen?.toFixed(1) || '0.0';
            document.getElementById('pressureValue').textContent = data.pressure?.toFixed(1) || '0.0';
            document.getElementById('depthValue').textContent = data.depth?.toFixed(1) || '0.0';
            
            // Update location info
            document.getElementById('latitude').textContent = data.location?.lat?.toFixed(6) || '--';
            document.getElementById('longitude').textContent = data.location?.lon?.toFixed(6) || '--';
            document.getElementById('satellites').textContent = data.location?.satellites || '--';
            
            // Update data quality
            document.getElementById('dataQuality').textContent = (data.quality || 0) + '%';
            
            // Update pump status
            const pumpElement = document.getElementById('pumpStatus');
            if (data.pump_state) {
                pumpElement.textContent = 'ON';
                pumpElement.className = 'pump-status on';
            } else {
                pumpElement.textContent = 'OFF';
                pumpElement.className = 'pump-status off';
            }
            
            // Update timestamp
            updateTimestamp();
        }
        
        // Store historical data
        function storeData(data) {
            const timestamp = new Date().toLocaleTimeString();
            
            // Add new data
            historicalData.timestamps.push(timestamp);
            historicalData.speed.push(data.speed_cms || 0);
            historicalData.temperature.push(data.temperature || 0);
            historicalData.dissolvedOxygen.push(data.dissolved_oxygen || 0);
            historicalData.pressure.push(data.pressure || 0);
            historicalData.depth.push(data.depth || 0);
            
            // Limit data points
            if (historicalData.timestamps.length > MAX_DATA_POINTS) {
                Object.keys(historicalData).forEach(key => {
                    historicalData[key].shift();
                });
            }
        }
        
        // Update all charts
        function updateCharts() {
            // Update speed chart
            speedChart.data.labels = historicalData.timestamps;
            speedChart.data.datasets[0].data = historicalData.speed;
            speedChart.update('none');
            
            // Update temperature chart
            tempChart.data.labels = historicalData.timestamps;
            tempChart.data.datasets[0].data = historicalData.temperature;
            tempChart.update('none');
            
            // Update DO chart
            doChart.data.labels = historicalData.timestamps;
            doChart.data.datasets[0].data = historicalData.dissolvedOxygen;
            doChart.update('none');
            
            // Update pressure chart
            pressureChart.data.labels = historicalData.timestamps;
            pressureChart.data.datasets[0].data = historicalData.pressure;
            pressureChart.update('none');
        }
        
        // Update map with GPS location
        function updateMap(data) {
            if (data.location && data.location.lat && data.location.lon) {
                const lat = data.location.lat;
                const lon = data.location.lon;
                
                // Add to path
                pathCoordinates.push([lat, lon]);
                if (pathCoordinates.length > 100) {
                    pathCoordinates.shift(); // Limit path length
                }
                
                // Update path line
                pathLine.setLatLngs(pathCoordinates);
                
                // Update or create marker
                if (marker) {
                    marker.setLatLng([lat, lon]);
                } else {
                    marker = L.marker([lat, lon], {
                        title: 'Lokasi',
                        icon: L.divIcon({
                            className: 'custom-marker',
                            html: '🐟',
                            iconSize: [30, 30]
                        })
                    }).addTo(map);
                }
                
                // Center map on new location (only if first time)
                if (pathCoordinates.length === 1) {
                    map.setView([lat, lon], 13);
                }
            }
        }
        
        // Check for alerts based on thresholds
        function checkAlerts(data) {
            // Temperature alert
            if (data.temperature < 20 || data.temperature > 32) {
                showAlert(`⚠️ Temperature warning: ${data.temperature.toFixed(1)}°C`, 'warning');
            }
            
            // DO alert
            if (data.dissolved_oxygen < 4) {
                showAlert(`⚠️ Low oxygen level: ${data.dissolved_oxygen.toFixed(1)} mg/L`, 'danger');
            }
            
            // Pressure alert
            if (Math.abs(data.pressure + 20) > 5) {
                showAlert(`⚠️ Abnormal pressure: ${data.pressure.toFixed(1)} kPa`, 'warning');
            }
            
            // Depth alert
            if (data.depth > 25) {
                showAlert(`⚠️ Deep dive detected: ${data.depth.toFixed(1)} m`, 'warning');
            }
        }
        
        // Update data table
        function updateDataTable(data) {
            const tableBody = document.getElementById('dataTableBody');
            const MAX_TABLE_ROWS = 10; // Batas jumlah baris yang ingin ditampilkan

            // Hapus pesan "Waiting for data..." jika masih ada
            const firstRow = tableBody.rows[0];
            if (firstRow && firstRow.cells.length === 1) {
                tableBody.innerHTML = ''; // Kosongkan isi tabel
            }

            // Buat baris baru (<tr>)
            const newRow = document.createElement('tr');

            // Buat dan isi sel-sel (<td>) sesuai urutan kolom
            const timestamp = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const speed = data.speed_cms?.toFixed(1) || '-';
            const temp = data.temperature?.toFixed(1) || '-';
            const oxygen = data.dissolved_oxygen?.toFixed(1) || '-';
            const pressure = data.pressure?.toFixed(1) || '-'; // Ini adalah "Daya Hisap"
            const depth = data.depth?.toFixed(1) || '-';
            const quality = `${data.quality || 0}%`;

            // Masukkan data ke dalam baris baru
            newRow.innerHTML = `
                <td>${timestamp}</td>
                <td>${speed}</td>
                <td>${temp}</td>
                <td>${oxygen}</td>
                <td>${pressure}</td>
                <td>${depth}</td>
                <td>${quality}</td>
            `;

            // Tambahkan baris baru ke bagian paling atas tabel
            tableBody.prepend(newRow);

            // Jaga agar jumlah baris tidak melebihi batas
            if (tableBody.rows.length > MAX_TABLE_ROWS) {
                tableBody.deleteRow(tableBody.rows.length - 1); // Hapus baris paling bawah
            }
        }
        
        // Update connection status indicator
        function updateConnectionStatus(isConnected) {
            const statusElement = document.getElementById('connectionStatus');
            const statusText = document.getElementById('connectionText');
            
            if (isConnected) {
                statusElement.classList.add('connected');
                statusText.textContent = 'Connected';
                statusText.style.color = '#27ae60';
            } else {
                statusElement.classList.remove('connected');
                statusText.textContent = 'Disconnected';
                statusText.style.color = '#e74c3c';
            }
        }
        
        // Update timestamp
        function updateTimestamp() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
        }
        
        // Show alert message
        function showAlert(message, type = 'warning') {
            const alertsContainer = document.getElementById('alertsContainer');
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = message;
            
            alertsContainer.insertBefore(alert, alertsContainer.firstChild);
            
            // Remove old alerts
            while (alertsContainer.children.length > 3) {
                alertsContainer.removeChild(alertsContainer.lastChild);
            }
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 5000);
        }
        
        // Control functions
        function exportData() {
            // Create CSV data
            let csv = 'Waktu, Kecepatan (cm/s), Suhu (°C), Kadar Oksigen (mg/L), Daya Hisap (kPa), Kedalaman (m), Percepatan-X (g), Percepatan-Y (g), Percepatan-Z (g)\n';
            
            for (let i = 0; i < historicalData.timestamps.length; i++) {
                csv += `${historicalData.timestamps[i]},`;
                csv += `${historicalData.speed[i]?.toFixed(2)},`;
                csv += `${historicalData.temperature[i]?.toFixed(2)},`;
                csv += `${historicalData.dissolvedOxygen[i]?.toFixed(2)},`;
                csv += `${historicalData.pressure[i]?.toFixed(2)},`;
                csv += `${historicalData.depth[i]?.toFixed(2)},`;
            }
            
            // Download file
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `monitoring_hiu_paus_${new Date().toISOString()}.csv`;
            a.click();
            
            showAlert('Data Diekspor!', 'success');
        }
        
        function clearCharts() {
            // Clear all historical data
            Object.keys(historicalData).forEach(key => {
                historicalData[key] = [];
            });
            
            // Update all charts
            updateCharts();
            
            // Clear path on map
            pathCoordinates = [];
            pathLine.setLatLngs([]);
            
            showAlert('Data Dibersihkan!', 'success');
        }
        
        function emergencyRelease() {
            if (confirm('Melepas Alat Monitoring dari Hiu Paus?')) {
                // Send emergency command via MQTT
                if (mqttClient && connected) {
                    const message = new Paho.MQTT.Message(JSON.stringify({
                        command: 'emergency_release',
                        timestamp: Date.now()
                    }));
                    message.destinationName = 'fish/monitor/command';
                    mqttClient.send(message);
                    
                    showAlert('Alat Dilepas!', 'danger');
                } else {
                    showAlert('Alat Dilepas!', 'danger');
                }
            }
        }
        
        // Generate demo data for testing
        function generateDemoData() {
            const demoData = {
                device_id: "Azfazaki Hakimi",
                timestamp: Date.now() / 1000,
                temperature: 25 + Math.random() * 5,
                dissolved_oxygen: 6 + Math.random() * 3,
                pressure: -20 + Math.random() * 4 - 2,
                depth: Math.random() * 10,
                speed_cms: 20 + Math.random() * 40,
                location: {
                    lat: -7.797068 + (Math.random() - 0.5) * 0.01,
                    lon: 110.370529 + (Math.random() - 0.5) * 0.01,
                    satellites: Math.floor(5 + Math.random() * 5)
                },

                quality: Math.floor(70 + Math.random() * 30),
                pump_state: Math.random() > 0.7
            };
            
            return demoData;
        }
        
        function startDemoMode() {
            console.log('Starting Demo Mode...');
            showAlert('Demo Mode', 'success');
            
            setInterval(() => {
                const demoData = generateDemoData();
                updateDashboard(demoData);
                storeData(demoData);
                updateCharts();
                updateMap(demoData);
                updateDataTable(demoData);
            }, 2000);
        }

        startDemoMode();
    </script>

    <script src="/socket.io/socket.io.js"></script>
    <script src="script.js"></script> </body>

     <a href="https://wa.me/6282222216470" id="whatsapp-button" target="_blank" title="Hubungi Developer">
        <i class="fab fa-whatsapp"></i>
    </a>

    <!-- Footer Credit -->
    <footer class="footer-credit">
        <div class="credit-content">
            <div class="credit-line"></div>
            <div class="credit-text">
                <span class="credit-icon">🐟</span>
                <span>Developed with <span class="heart">❤️</span> by</span>
                <span class="credit-name">Nadine Adzka Faustina</span>
                <span class="credit-year">© 2025</span>
            </div>
            <div class="credit-line"></div>
        </div>
    </footer>

</body>
</html>